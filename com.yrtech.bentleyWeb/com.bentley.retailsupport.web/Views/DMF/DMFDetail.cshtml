@{
    ViewBag.Title = "DMFDetail";

}

<style>
    html {
        overflow: auto;
        overflow-y: hidden;
        overflow-x: hidden;
    }

    .widget {
        margin-bottom: 5px !important;
    }

    .widget-body {
        padding: 5px 5px 1px 5px !important;
    }

    .page-content {
        padding: 5px 5px 1px 5px !important;
    }

    select, textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"], .uneditable-input {
        margin-bottom: 4px !important;
    }

    .fixed-table-pagination div.pagination, .fixed-table-pagination .pagination-detail {
        margin-top: 5px !important;
        margin-bottom: 0px !important;
    }

    .td {
        text-align: center;
    }
</style>

<div style="display:none">
    <input id="NO" type="hidden" value="{{'NO'|translate}}" />
    <input id="Dealer" type="hidden" value="{{'Dealer'|translate}}" />
    <input id="TRemark" type="hidden" value="{{'Remark'|translate}}" />
    <input id="TAE" type="hidden" value="{{'Actual Expense'|translate}}" />
    <input id="TBudget" type="hidden" value="{{'Budget'|translate}}" />
    <input id="TEI" type="hidden" value="{{'Tick-box Item'|translate}}" />

    <input id="ShopId" type="hidden" value="@ViewBag.ShopId" />

</div>
<form id="upload-form" style="display:none">
    <input type='file' id='uploadFile'>
</form>

<div id="page-wrapper">
    <!--BEGIN CONTENT-->
    <div class="page-content">
        <div id="tab-general">
            <div class="row mbl">
                <div class="col-lg-12">
                    <div class="col-md-12">
                        <div id="area-chart-spline" style="width: 100%; height: 300px; display: none;">
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div id="main-content">
                        <div class="container-fluid">
                            <p id="phbuttons">
                                <a class="btn btn-primary" style="margin-left:2px;" onclick="downloadFile()"><i class="icon-download-alt"></i><span translate>Export</span></a>
                                <a id="selectfiles" class="btn btn-primary" style="margin-left:2px;"><i class="icon-upload-alt"></i><span translate>Import</span></a>                               
                                <a class="btn btn-link" id="templateDownloadA"><i class="icon-plus icon-white"></i><span translate>Download Templates</span></a>
                                <div id="upload-container" class="container-fluid" style="display:none">
                                    <div id="ossfile"></div>
                                </div> 
                            </p>

                            <div class="row-fluid">
                                <div class="span12">

                                    <!-- BEGIN EXAMPLE TABLE widget-->
                                    <div class="widget">
                                        <div class="widget-title">
                                            <h4><i class="icon-reorder"></i><span translate>Budget and Expense</span></h4>
                                            <span class="tools">
                                                <a href="javascript:;" class="icon-chevron-down" onclick="ShowDiv()"></a>
                                            </span>
                                        </div>
                                        <div class="widget-body" style="display: block;">
                                            <div class="row-fluid">
                                                <span class="span12">
                                                    <div id="formsousuo" style="margin-bottom:5px">
                                                        <a class="btn btn-default" href="javascript:;" onclick="Add()"><i class="glyphicon glyphicon-plus"></i><span translate>Add</span></a>
                                                        <a class="btn btn-default" href="javascript:;" onclick="DeleteBudgetCost()"><i class="glyphicon glyphicon-trash"></i><span translate>Delete</span></a>
                                                        <select class="input-small m-wrap no-margin" id="pdealer" name="pdealer" style="background-color: white;" onchange="NameQuery()">
                                                            <option value="" translate>Dealer Name</option>
                                                        </select>
                                                        <input type="text" id="pname" name="pname" placeholder="项目" onchange="NameQuery()" onkeypress="EnterPress(event)" />
                                                    </div>
                                                </span>
                                            </div>
                                            <div id="toptable" class="widget-body" style="margin-left:10px;display:none">
                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <div class="table-responsible">
                                                            <table id="chart" class="table table-bordered" align="center">
                                                                <thead>
                                                                    <tr>
                                                                        <th class="td" translate>Quarter</th>
                                                                        <th class="td" translate>AAH</th>
                                                                        <th class="td" translate>0.8% MKT Fund (RMB)</th>
                                                                        <th class="td" translate>Actual Expense (RMB)</th>
                                                                        <th class="td col-xs-4" translate>Balance(RMB)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td class="td">Q1</td>
                                                                        <td class="td">0</td>
                                                                        <td class="td">0</td>
                                                                        <td class="td" rowspan="5" style="vertical-align:middle;font-weight:bold">0</td>
                                                                        <td class="td" rowspan="5" style="vertical-align:middle;font-weight:bold">0</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="td">Q2</td>
                                                                        <td class="td">0</td>
                                                                        <td class="td">0</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="td">Q3</td>
                                                                        <td class="td">0</td>
                                                                        <td class="td">0</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="td">Q4</td>
                                                                        <td class="td">0</td>
                                                                        <td class="td">0</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="td" style="vertical-align:middle;font-weight:bold">Total</td>
                                                                        <td class="td" style="vertical-align:middle;font-weight:bold">0</td>
                                                                        <td class="td" style="vertical-align:middle;font-weight:bold">0</td>
                                                                    </tr>

                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <br />
                                            <div class="dataTables_wrapper form-inline" role="grid" id="myPro">
                                                <table id="myBudgetCost" class="table table-striped table-bordered table-hover" data-height="100%"></table>
                                                <div id="totalDiv" style="margin-bottom:10px;margin-left:5px;margin-top:2px"></div>
                                            </div>

                                        </div>
                                    </div>
                                    <!-- END EXAMPLE TABLE widget-->
                                </div>
                            </div>
                            <!-- END ADVANCED TABLE widget-->
                            <!-- END PAGE CONTENT-->
                        </div>
                    </div>
                    <!--END CONTENT-->
                </div>
            </div>
        </div>
    </div>
    <!--END CONTENT-->
</div>

@section scripts{
    <script src="~/Scripts/api/common.js"></script>
    <script src="~/Scripts/curtom/BudgetCost.js"></script>
    <script src="~/Scripts/xlsx.core.min.js"></script>
    <script src="~/Scripts/crypto-js.js"></script>
    <script src="~/Scripts/curtom/DESUtil.js"></script>

    <script src="~/Scripts/oss-upload-direct/lib/crypto1/crypto/crypto.js"></script>
    <script src="~/Scripts/oss-upload-direct/lib/crypto1/hmac/hmac.js"></script>
    <script src="~/Scripts/oss-upload-direct/lib/crypto1/sha1/sha1.js"></script>
    <script src="~/Scripts/oss-upload-direct/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
    <script src="~/Scripts/oss-upload-direct/lib/base64.js"></script>
    <script src="~/Scripts/oss-upload-direct/upload.js?20200229"></script>

    <script type="text/javascript">
        if (!$("#ShopId").val()) {
            $("#nav_budget_cost").addClass("active");
        }

        var $table = $('#myBudgetCost');
        var roleType = $("#G_RoleTypeCode").val();
        var account = $("#G_AccountId").val();
        var hdData = [];
        var dmfData = [];

        var osspath = "Bentley/" + year + "/ImportData/";
        var ossClient;
        $(function () {
            //初始化LexusReport OSS 数据源
            initOssClient();

            //下载模板地址
            templateDownloadA.href = host + "/Content/Excel/DMFDetail.xlsx";

            loadShops().forEach(function (item) {
                var shopName = isZH() ? item.ShopName : item.ShopNameEn;
                $("#pdealer").append($("<option>").val(item.ShopId).text(shopName));
                hdData.push({ value: item.ShopId, text: shopName });
            });

            if (roleType != "SYSADMIN") {
                $("#formsousuo").parent().remove();
            }

            if (roleType == "SHOP" || $("#ShopId").val()) {
                $('#toptable').show();
                $('#phbuttons').hide();
                $("#pdealer").remove();
                $("#pname").remove();
            }
            else {
                $('#toptable').hide();
            }

            $.ajaxSettings.async = false;
            $.commonGet("DMF/DMFItemSearch", {
                DMFItemId: '',
                DMFItemName: '',
                DMFItemNameEn: '',
                expenseAccountChk: '',
                publishChk: ''
            }, function (data) {
                if (data) {
                    data.forEach(function (item) {
                        dmfData.push({ text: isZH() ? item.DMFItemName : item.DMFItemNameEn, value: item.DMFItemId });
                    })
                }
            });
            $.ajaxSettings.async = true;

            var clientWidth = document.body.clientWidth;
            $(window).resize(function () {
                if (document.body.clientWidth != clientWidth) {
                    $table.bootstrapTable('destroy');// 销毁表格数据
                    loadDMFDetailOrQuarter();
                }
                clientWidth = document.body.clientWidth;
            });
            loadDMFDetailOrQuarter();
        })
        
        function initOssClient() {
            ossClient = new OSSClient({
                fileAddCheck: function () {
                    return true;
                },
                fileAddCheckMsg: "",
                osspath: osspath,
                uploaded: function (args) {
                    //调用导入方法
                    $.commonGet("DMF/DMFDetailImportServer", {
                        userId: $("#G_UserId").val(),
                        ossPath: args.osspath
                    }, function (data) {
                        loadDMFDetail();
                    });
                }
            });
        }

        function loadDMFDetailOrQuarter() {
            InitDMFDetail();
            if (roleType == "SHOP" || $("#ShopId").val()) {
                loadDMFQuarter();
            } else {
                loadDMFDetail();
            }
            HideColumn();
        }

        function HideColumn() {
            $table.bootstrapTable('hideColumn', 'isReimburse');
            if (roleType == "SHOP") {
                $table.bootstrapTable('hideColumn', 'checkedId');
            }
        }

        function NameQuery() {
            loadDMFDetail();
        }

        function loadDMFDetail() {
            $.commonGet("DMF/DMFDetailSearch", {
                dmfDetailId: '',
                shopId: $("#pdealer").val(),
                dmfItemId: '',
                dmfItemName: $('#pname').val()
            }, function (data) {
                if (data) {
                    $table.bootstrapTable("load", data);
                    loadTotalDiv();
                }
            });
        }
        function loadDMFQuarter() {
            var shopId;
            if ($("#pdealer").length > 0) {
                shopId = $("#pdealer").val();
            } else if (roleType == "SHOP") {
                shopId = loadShops()[0].ShopId;
            } else {
                shopId = $("#ShopId").val();
            }

            $.commonGet("DMF/DMFQuarterSearch", {
                shopId: shopId
            }, function (data) {
                if (data) {
                    $table.bootstrapTable("load", data.DMFDetailList);
                    loadTopTable(data.DMFQuarterList)
                    loadTotalDiv();
                }
            });
        }
        var pageNumber = 1, pageSize = 10;
        function loadTotalDiv() {
            var rows = $table.bootstrapTable('getData');
            var start = pageSize * (pageNumber - 1);
            var end = pageNumber * pageSize > rows.length ? rows.length : pageNumber * pageSize;
            var sumBuget = 0;
            var sumCost = 0;
            for (var i = start; i < end; i++) {
                sumBuget += parseFloat(rows[i]["Budget"]);
                sumCost += parseFloat(rows[i]["AcutalAmt"]);
            }
            $("#totalDiv").html("<span>" + (isZH() ? "预算花费总计" : "Total Budget Amount") + "：" + dealNumber(sumBuget) + "</span/> &nbsp;&nbsp; &nbsp;&nbsp; " + (isZH() ? "实际花费总计" : "Total Actual Expense") + "：" + dealNumber(sumCost));
        }

        function loadTopTable(quarterList) {
            if (quarterList && quarterList.length > 0) {
                var sumNum = 0;
                var sumIncome = 0;
                var tbl = document.getElementById('chart');
                for (var i in quarterList) {
                    var quarter = quarterList[i];
                    if (quarter.Quarters == "Q1") {
                        tbl.rows[1].cells[1].innerHTML = quarter.ActualMonthSaleCount;
                        tbl.rows[1].cells[2].innerHTML = quarter.ActualMonthSaleAmt;
                    }
                    else if (quarter.Quarters == "Q2") {
                        tbl.rows[2].cells[1].innerHTML = quarter.ActualMonthSaleCount;
                        tbl.rows[2].cells[2].innerHTML = quarter.ActualMonthSaleAmt;
                    }
                    else if (quarter.Quarters == "Q3") {
                        tbl.rows[3].cells[1].innerHTML = quarter.ActualMonthSaleCount;
                        tbl.rows[3].cells[2].innerHTML = quarter.ActualMonthSaleAmt;
                    }
                    else {
                        tbl.rows[4].cells[1].innerHTML = quarter.ActualMonthSaleCount;
                        tbl.rows[4].cells[2].innerHTML = quarter.ActualMonthSaleAmt;
                    }
                    sumNum += parseInt(quarter.ActualMonthSaleCount);
                    sumIncome += parseFloat(quarter.ActualMonthSaleAmt);
                }


                tbl.rows[1].cells[3].innerHTML = dealNumber(quarterList[0].ActualAmt);
                tbl.rows[5].cells[1].innerHTML = sumNum;
                tbl.rows[5].cells[2].innerHTML = dealNumber(sumIncome);
                var howmuch = quarterList[0].DiffAmt;
                if (howmuch > 0) {
                    tbl.rows[1].cells[4].innerHTML = dealNumber(howmuch);
                } else {
                    var newMsg = isZH() ? "如基金年度差额为负值，宾利汽车中国将暂停向经销商的款项支付，处理意见另行通知" : "If the annual balance is negative, BMC will withhold the payment for the retailer until further notice";
                    tbl.rows[1].cells[4].innerHTML = "<font color='red'>" + dealNumber(howmuch) + "</font><br/><p>" + newMsg + "</p>";
                }
            }

        }

        function downloadFile() {
            $.commonGet("DMF/DMFDetailExport", {
                shopId: $("#pdealer").val(),
                dmfItemName: $('#pname').val(),
                userId: $("#G_UserId").val(),
                roleTypeCode: $("#G_RoleTypeCode").val()
            }, function (data) {
                if (data) {
                    window.location.href = host + "download/DownloadFile?filepath=" + data.FilePath;
                }
            })
        }

        //导入文件事件
        $("#uploadFile").change(uploadDMFDetails);
        function uploadFile() {
            $("#uploadFile").click();
            return false;
        };

        function uploadDMFDetails() {
            var file_obj = document.getElementById('uploadFile').files[0];
            readWorkbookFromLocalFile(file_obj, function (workbook) {
                document.getElementById('uploadFile').value = '';
                var worksheet = workbook.Sheets['我的工作表'];
                var json = XLSX.utils.sheet_to_json(worksheet);
                if (json && json.length > 0) {
                    var dmfDetails = [];
                    $.each(json, function (i, item) {
                        if (i == 0) return;
                        try {
                            var ShopName = $.trim(item["DealerName"]);
                            var DMFItemName = $.trim(item["ProjectName"]);
                            var Budget = $.trim(item["BudgetCost"]);
                            var AcutalAmt = $.trim(item["ActualCost"]);
                            var Remark = $.trim(item["Remark"]);

                            dmfDetails.push({
                                DMFItemName: DMFItemName,
                                ShopName: ShopName,
                                Budget: Budget,
                                AcutalAmt: AcutalAmt,
                                Remark: Remark,
                                InUserId: $("#G_UserId").val(),
                                ModifyUserId: $("#G_UserId").val()
                            });

                        } catch (e) {
                            console.error('读取市场基金详情出错', e);
                        }

                    })
                    importDMFDetails(dmfDetails);
                } else {
                    alert("Excel中没有清单数据！");
                }
            })
        }

        // 读取本地excel文件
        function readWorkbookFromLocalFile(file, callback) {
            var reader = new FileReader();
            reader.onload = function (data) {
                var data = data.content;
                var workbook = XLSX.read(data, { type: 'binary' });
                if (callback) callback(workbook);
            };
            reader.readAsBinaryString(file);
        }

        //导入基金详情信息
        function importDMFDetails(dmfDetails) {
            SProcessing();
            $.commonPost("DMF/DMFDetailImport", {
                UserId: $("#G_UserId").val(),
                ListJson: JSON.stringify(dmfDetails)
            }, function (data) {
                EProcessing();
                console.log(data);
                loadDMFDetail();
            }, EProcessing);
        }


        function SProcessing() {
            //loading层
            var index = layer.load(1, {
                shade: [0.1, '#fff'] //0.1透明度的白色背景
            });
        }
        function EProcessing() {
            layer.closeAll('loading');
        }

        function EnterPress(e) { //传入 event
            var e = e || window.event;
            if (e.keyCode == 13) { //13代表回车符
                NameQuery();
            }
        }
    </script>
}